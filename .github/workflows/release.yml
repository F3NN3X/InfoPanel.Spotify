name: Release Build

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore InfoPanel.Spotify/InfoPanel.Spotify.csproj

    - name: Build Plugin
      run: dotnet build InfoPanel.Spotify/InfoPanel.Spotify.csproj --configuration Release --no-restore

    - name: Get Version from Project
      id: get_version
      shell: pwsh
      run: |
        [xml]$csproj = Get-Content "InfoPanel.Spotify/InfoPanel.Spotify.csproj"
        $versionNode = $csproj.SelectSingleNode("//Version")

        if ($null -eq $versionNode) {
            Write-Error "Could not find <Version> tag in .csproj file"
            exit 1
        }

        $version = $versionNode.InnerText.Trim()
        echo "Detected Version: '$version'"
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT

    - name: Package Plugin
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $sourcePath = "InfoPanel.Spotify\bin\Release\net8.0-windows\InfoPanel.Spotify-v$version\InfoPanel.Spotify"
        $zipName = "InfoPanel.Spotify-v$version.zip"

        if (Test-Path $sourcePath) {
            Write-Host "Zipping build output from: $sourcePath"
            Compress-Archive -Path "$sourcePath" -DestinationPath $zipName -ErrorAction Stop

            if (-not (Test-Path $zipName)) {
                Write-Error "ZIP file was not created at $zipName"
                exit 1
            }
            Write-Host "ZIP file created successfully: $zipName"
        } else {
            Write-Error "Build output directory not found at $sourcePath"
            exit 1
        }

    - name: Get Current Date
      id: get_date
      shell: pwsh
      run: echo "DATE=$(Get-Date -Format 'MMM dd, yyyy')" >> $env:GITHUB_OUTPUT

    - name: Extract Release Notes
      id: extract_release_notes
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $changelog = Get-Content "CHANGELOG.md"
        $recording = $false
        $notes = @()

        foreach ($line in $changelog) {
            if ($line -match "^## \[$version\]") {
                $recording = $true
                continue
            }
            if ($recording -and $line -match "^## \[") {
                break
            }
            if ($recording) {
                $notes += $line
            }
        }

        $body = $notes -join "`n"
        $body = $body.Trim()

        if ([string]::IsNullOrWhiteSpace($body)) {
            $body = "See CHANGELOG.md for details."
        }

        $releaseNotesPath = "release_notes.md"
        Set-Content -Path $releaseNotesPath -Value $body
        echo "NOTES_PATH=$releaseNotesPath" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: InfoPanel.Spotify-v${{ steps.get_version.outputs.VERSION }}.zip
        body_path: ${{ steps.extract_release_notes.outputs.NOTES_PATH }}
        name: "[${{ steps.get_version.outputs.VERSION }}] - ${{ steps.get_date.outputs.DATE }}"
        draft: false
        prerelease: false
